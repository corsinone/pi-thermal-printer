= Thermal printer
:author: Gianluca Corsini
:date: Dec. 25 2024
:toc: right
:imagesdir: ./doc/images/
// this is necessary for enabling menu macros
:experimental:

== Introduction

This repository contains instructions on how to use a thermal printer connected to your Raspberry, and send characters to it through Python scripts.

== Repository content

boot:: Contains configuration files that are stored in the Raspberry within either the directory `/boot/firmware` or `/boot`. All the files are provided as examples; those with the extension `.bkp` are examples of backups.
doc:: Contains the material used to write the documentation, e.g., the images. +
At the moment of writing, the entry point for the documentation is the `README` file at the root of the repository.
python:: Contains examples of Python scripts which send characters to the thermal printer over the serial port.
setup:: Contains setup material, such as configuration scripts.

== Setup

First, it is necessary to configure the Raspberry device.

=== Install OS

You need to install an OS on your Raspberry.
These steps have been tested with Octoprint and Raspbian, while others may work and thus result in similar steps.

=== Configuration

Once the OS is installed, connect to your raspberry by SSH. Usually, the username is `pi` and the password `raspberry`, if not modified during the installation process.

TIP: On Windows, you can use link:https://www.putty.org/[PuTTY] to connect through ssh to your raspberry (which should be connected to the same network as your PC).

Once logged in, open a terminal and follow these steps.

* Type `sudo raspi-config`
* Select `Interface Options` and press the key btn:[ENTER] on your keyboard.
* Select the option `Serial Port`.i
* The message `Would you like a login shell to be accessible over serial?` should appear.
* Move the cursors on the button btn:[<No>] with the arrow keys of your keyboard, and press the key btn:[ENTER].
* Next, at the question `Would you like the serial port hardware to be enabled?` confirm on the button btn:[<Yes>].
* Now, you should get the following message:
+
----
 The serial login shell is disabled
 The serial interface is enabled
----
* Press on the button btn:[<Ok>].
* Lastly, at the question whether to reboot or not the device, confirm with the button btn:[<Yes>].
* Wait for the Raspberry to reboot, then log in back through SSH (in the meantime you should have logged out).

Next:

* Navigate to the directory `/boot/firmware` if you are using `Raspbian` as OS. Otherwise, if you are using `Octoprint` as OS, move to the directory `/boot`. +
In order to do that, simply type
+
[source,shell]
----
$ dest_dir=/boot/firmware # if Raspbian, else if Octoprint use '/boot'
$ cd $dest_dir
----

* Locate the files `cmdline.txt` and `config.txt` by typing `ls *.txt`.
* Create a backup for those files by simply typing the following commands:

[source,shell]
----
$ sudo cp ${dest_dir}/cmdline.txt ${dest_dir}/cmdline.txt.bkp
$ sudo cp ${dest_dir}/config.txt ${dest_dir}/config.txt.bkp
----

* First, make sure that `enable_uart=1` is uncommented in `config.txt`.
** To check that, you can type: `cat config.txt | grep uart`. +
If uncommented, the line should *NOT* start with the character `#`.
** If this is not the case, you need to modify that line manually.
*** If that is the case, you can type `nano config.txt`.
*** Navigate to that line with the arrow keys and remove the character `#` at its beginning.
*** Press the keys btn:[<CTRL>]+btn:[<X>] on your keyboard and press btn:[<ENTER>].
* Then, edit the file `cmdline.txt` by replacing the line +
+
[source]
----
console=serial0,115200 console=tty1 root=PARTUUID=6a216d26-02 rootfstype=ext4 fsck.repair=yes rootwait
----
+
with this other line+
+
[source]
----
dwc_otg.lpm_enable=0 console=tty1 root=PARTUUID=6a216d26-02 rootfstype=ext4 fsck.repair=yes rootwait quiet splash plymouth.ignore-serial-consoles
----

IMPORTANT: Make sure to avoid replacing the value of `root`, since it may differ from case to case.

Once done these steps, you should be able to use the serial on the GPIO 13 and 14, which are mapped to the system file `/dev/serial0`.
The latter (i.e., `/dev/serial0`) will be the name of the serial port to be used in Python.

=== Clone the repository

At this point, this repository can be cloned into the Raspberry.
You can clone it anywhere you like, for instance, in your `HOME`.

[source, bash]
----
$ cd $HOME
$ git clone https://github.com/corsinone/pi-thermal-printer.git
----

=== System packages

Lets install the necessary system and python packages.

First of all, lets update all the system packages; it is not necessary but it is good practice to keep the system updated.
Therefore, in a terminal, run `sudo apt update && sudo apt upgrade -y`.
Then, lets install `git`, which may come handy. Thus, type `sudo apt install -y git`.
Lastly, we need `python3` and the package `python3-serial`: the former will install the python interpreter, while the latter allows using any serial in python. So, we run `sudo apt install -y python3 python3-serial`.

Alternatively, you can do the same instructions above by simply running the shell script `install_dependencies.sh` in the directory `setup` of this 
repository.
Thus,

[source, bash]
----
$ cd pi-thermal-printer/setup
$ sudo chmod +x install_dependencies.sh
$ sudo ./install_dependencies.sh
----

Once done these steps, it should be possible to send and receive bytes over the serial by using a python script.

== Test of the configuration

To test the configuration done so far, we can use `pyserial-miniterm`, which comes installed with `python3-serial`.

Therefore, in a terminal, type

[source, bash]
----
$ pyserial-miniterm /dev/serial0 9600
----

This should open a console, where we can type any character on the serial.
By typing anything, the printer should start printing each typed character.
If you press the key btn:[<ENTER>], it should escape to a new line.

Then, press the keys btn:[<CTRL>]+btn:[<]>] to quit.

IMPORTANT: In case of issues, please consult the Section <<_known_issues>>.

== Python

Now, thanks to `python3-serial`, we can create python scripts that open the serial `/dev/serial0` and send characters to it.
Examples are provided in the directory `python` within this repository.

To run any of those script, in the terminal, type:

[source, bash]
----
$ cd pi-thermal-printer/python
$ python3 <script_name>.py #for example, $ python3 print_eject_paper.py
----

This should run the script and send data over the serial.

== Known issues

=== Error when connecting to /dev/serial0

If the following error occurs:

[source]
----
could not open port '/dev/serial0': [Errno 11] Could not exclusively lock port /dev/serial0: [Errno 11] Resource temporarily unavailable
----

Make sure to check the configuration of Octoprint, if it is running.

* Open the browser and navigate to the IP of the Octoprint web server (i.e., the same IP of your raspberry).
* Once landed into the home, click on the `Connection` panel to expand it, as shown in the image below.

image::octoprint_home.png[Octoprint Homepage]

* Make sure that the value of `Serial Port` is not in `AUTO` but set to the correct serial port which the *controller of the 3D printer* is connected to. +
In the case of the image below, it is `/dev/ttyACM0`. +
Then, click on the button btn:[Connect]. Once the controller is connected, the button should change to btn:[Disconnect], as shown in the image below.

image::octoprint_connection.png["Octoprint Homepage > Connection panel"]
